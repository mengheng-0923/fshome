name: Deploy Vite App to Server via SSH (Fixed)

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯çš„æŽ¨é€äº‹ä»¶

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.DEPLOY_SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy with SSH and run commands
        run: |
          ssh ${{ secrets.DEPLOY_SERVER_USERNAME }}@${{ secrets.DEPLOY_SERVER_HOST }} <<'EOF'
            TARGET_DIR="${{ secrets.DEPLOY_TARGET_DIR }}"
            # âœ… ä¿®æ­£åŽçš„ REPO_URL è¯­æ³• âœ…
            REPO_URL="github.com{{ github.repository }}.git"

            echo "Starting deployment to $TARGET_DIR"

            # æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­ç›®æ ‡ç›®å½•æ˜¯å¦å­˜åœ¨ .git ç›®å½•
            if [ ! -d "$TARGET_DIR/.git" ]; then
              echo "Repository not found in $TARGET_DIR. Cloning for the first time..."
              mkdir -p "$TARGET_DIR"
              git clone "$REPO_URL" "$TARGET_DIR"
            fi
            
            # è¿›å…¥ç›®æ ‡ç›®å½•
            cd "$TARGET_DIR"
            
            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆmain åˆ†æ”¯ï¼‰
            git pull origin main

            # --- ðŸ’¡ æž„å»ºå‘½ä»¤ ðŸ’¡ ---
            npm install      
            npm run build    
            # ----------------------

            echo "Deployment finished successfully."
          EOF
