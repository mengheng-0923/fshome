name: Deploy Vite App to Production Server (Fixed Logic)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts to trust server
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.DEPLOY_SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy and Build Application on Server
        run: |
          ssh ${{ secrets.DEPLOY_SERVER_USERNAME }}@${{ secrets.DEPLOY_SERVER_HOST }} <<'EOF'
            TARGET_DIR="${{ secrets.DEPLOY_TARGET_DIR }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            echo "Starting deployment to $TARGET_DIR"

            # ðŸš€ ä¼˜åŒ–åŽçš„é€»è¾‘ï¼šç¡®ä¿ç›®å½•å¯ç”¨ ðŸš€
            if [ ! -d "$TARGET_DIR/.git" ]; then
              echo "Repository not found locally. Cloning for the first time..."
              # å¦‚æžœç›®å½•éžç©ºï¼Œæ¸…ç©ºç›®å½•åŽå†å…‹éš†
              if [ "$(ls -A $TARGET_DIR)" ]; then
                echo "Directory not empty. Clearing contents..."
                rm -rf ${TARGET_DIR}/*
              fi
              mkdir -p "$TARGET_DIR"
              git clone "$REPO_URL" "$TARGET_DIR"
            else
              echo "Repository found. Pulling latest changes..."
            fi

            # è¿›å…¥ç›®æ ‡ç›®å½•ï¼ˆæ­¤æ—¶ç¡®å®šä»“åº“å·²å­˜åœ¨ï¼‰
            cd "$TARGET_DIR"

            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆmain åˆ†æ”¯ï¼‰
            git pull origin main

            # --- æž„å»ºæ­¥éª¤ (Vite App) ---
            echo "Installing dependencies and building Vite app..."
            npm install
            npm run build
            # ---------------------------

            echo "Deployment and build finished successfully."
          EOF
