name: Deploy Vite App to Production Server # æ˜ç¡®çš„å·¥ä½œæµç¨‹åç§°

on:
  push:
    branches:
      - main # ç›‘å¬ 'main' åˆ†æ”¯çš„æ¨é€äº‹ä»¶

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨ GitHub çš„æ ‡å‡†è™šæ‹Ÿæœºç¯å¢ƒ

    steps:
      - name: Checkout repository code # æ­¥éª¤ 1: è·å–æºä»£ç åˆ° GitHub è™šæ‹Ÿæœº
        uses: actions/checkout@v4

      - name: Set up SSH agent # æ­¥éª¤ 2: é…ç½® SSH ç§é’¥
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts to trust server # æ­¥éª¤ 3: ä¿¡ä»»æ‚¨çš„æœåŠ¡å™¨åœ°å€
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.DEPLOY_SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy and Build Application on Server # æ­¥éª¤ 4: è¿æ¥æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²å’Œæ„å»º
        run: |
          ssh ${{ secrets.DEPLOY_SERVER_USERNAME }}@${{ secrets.DEPLOY_SERVER_HOST }} <<'EOF'
            TARGET_DIR="${{ secrets.DEPLOY_TARGET_DIR }}"
            REPO_URL="github.com{{ github.repository }}.git"

            echo "Starting deployment to $TARGET_DIR"

            # æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœç›®æ ‡ç›®å½•æ²¡æœ‰ .git ä»“åº“ï¼Œåˆ™é¦–æ¬¡å…‹éš†ï¼›å¦åˆ™åªæ‹‰å–æ›´æ–°
            if [ ! -d "$TARGET_DIR/.git" ]; then
              echo "Repository not found locally. Cloning for the first time..."
              mkdir -p "$TARGET_DIR"
              git clone "$REPO_URL" "$TARGET_DIR"
            fi

            # è¿›å…¥ç›®æ ‡ç›®å½•
            cd "$TARGET_DIR"

            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆmain åˆ†æ”¯ï¼‰
            git pull origin main

            # --- ğŸš€ æ„å»ºæ­¥éª¤ (Vite App) ğŸš€ ---
            echo "Installing dependencies and building Vite app..."
            npm install
            npm run build
            # ------------------------------------

            echo "Deployment and build finished successfully."
          EOF
